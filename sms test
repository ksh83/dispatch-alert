# 🔧 진단 도구 (app = get_app_state() 호출 이후에 배치)
with st.expander("🔧 진단 도구", expanded=False):
    # 폼으로 감싸면 Streamlit의 rerun/버튼 상태 관리가 안정적입니다.
    with st.form(key="solapi_test_form"):
        test_phone = st.text_input(
            "테스트 수신번호(숫자만, 10~11자리)",
            key="test_phone_input",
            placeholder="01012345678",
        )
        submitted = st.form_submit_button("📨 Solapi 테스트 발송", use_container_width=True)

    if submitted:
        # valid_phone 이 없다고 나오면 아래 간단검증 함수를 함께 추가하세요.
        if not valid_phone(test_phone):
            st.error("전화번호 형식 오류 (숫자만, 10~11자리)")
        else:
            try:
                ok = app.sms.send(test_phone, "[테스트] 출동알림 시스템 연결 확인")
                if ok:
                    st.success("Solapi 호출 성공 (수신여부는 통신사/수신단 블록에 따라 지연될 수 있음)")
                else:
                    st.error("Solapi 호출 실패 (콘솔/터미널 로그 및 .env 설정 확인)")
            except Exception as e:
                st.exception(e)
